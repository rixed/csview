# vim:filetype=make
top_srcdir = @top_srcdir@
PKG_NAME = csview

CSVIEW_SOURCES = \
	color.ml chart.ml config.ml read_csv.ml csview.ml

LOADTESTER_SOURCES = csview_loadtester.ml

SOURCES = $(CSVIEW_SOURCES) $(LOADTESTER_SOURCES)

REQUIRES = batteries net_codecs parsercombinator owww

all: csview csview_loadtester.opt

include $(top_srcdir)/make.common

csview.opt: $(patsubst %.ml,%.cmx,$(CSVIEW_SOURCES))
	$(OCAMLOPT) -o $@ -package "$(REQUIRES)" -linkpkg $(OCAMLOPTFLAGS) $^
csview_loadtester.opt: csview_loadtester.cmx
	$(OCAMLOPT) -o $@ -package "$(REQUIRES)" -linkpkg $(OCAMLOPTFLAGS) $^

csview: csview.opt
	@$(RM) $@ && ln -f $< $@

clean:
	$(RM) *.cm[ioxa] *.cmxa *.cmxs *.a *.s *.o test.* .depend *.annot *.opt all_tests.ml

distclean: clean
	$(RM) *.byte *.opt

clear:
	sed -i.bak -e 's/[ 	]\+$$//' $(wildcard *.adoc)

install: csview
	install -D $(DESTDIR)$(prefix)/bin
	install csview $(DESTDIR)$(prefix)/bin

uninstall:
	echo TODO
	false

reinstall: uninstall install

# Tests

all_tests.ml: TestEnv.ml read_csv.ml config.ml
	$(QTEST) --shuffle --preamble 'open Batteries;; open TestEnv' -o $@ extract $^

all_tests.opt: TestEnv.cmx read_csv.cmx config.cmx all_tests.ml
	$(OCAMLOPT) -o $@ $(SYNTAX) -package "$(REQUIRES) qcheck" -linkpkg $(OCAMLOPTFLAGS) $^

check: all_tests.opt
	./all_tests.opt || echo "FAILURE"

# Dependencies

dep:
	$(RM) .depend
	$(MAKE) .depend

.depend: $(SOURCES)
	$(OCAMLDEP) -package "$(REQUIRES)" $(filter %.ml, $(SOURCES)) $(filter %.mli, $(SOURCES)) > $@

-include .depend
